<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Feedback | Rockel Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans p-6">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>

  <div class="max-w-5xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-1">Customer Feedback / Query Log</h2>
      <div id="customerLabel" class="text-gray-600 font-bold mb-4"></div>


    <form id="feedbackForm" class="space-y-4 mb-6">
      <input type="hidden" name="CustomerID" id="CustomerID">
      <input type="hidden" id="editingId" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select name="QueryType" class="p-2 border rounded" required>
          <option value="">Select Type</option>
          <option value="Issue">Issue</option>
          <option value="Complaint">Complaint</option>
          <option value="Query">Query</option>
          <option value="Feedback">Feedback</option>
        </select>

        <select name="Status" class="p-2 border rounded">
          <option value="Open">Open</option>
          <option value="Closed">Closed</option>
        </select>

        <select name="InvoiceID" class="p-2 border rounded" id="invoiceDropdown">
            <option value="">Linked Invoice (optional)</option>
          </select>
          
          <select name="BookingID" class="p-2 border rounded" id="bookingDropdown">
            <option value="">Linked Booking (optional)</option>
          </select>          
      </div>

      <input name="Title" placeholder="Title (optional)" class="w-full p-2 border rounded" />
      <textarea name="Message" placeholder="Enter details here..." class="w-full p-2 border rounded" rows="4" required></textarea>

      <div class="flex flex-wrap gap-4">
        <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded">Submit Feedback</button>
        <a href="/view-customer?id=${customerId}" id="backBtn" class="bg-green-600 text-white px-6 py-2 rounded">Back to Customer</a>
      </div>
    </form>

    <h3 class="text-xl font-semibold mb-3">All Feedback Entries</h3>
    <div id="feedbackList" class="space-y-3"></div>
  </div>

  <!-- All your existing HTML above remains unchanged -->

<script>
  const customerId = new URLSearchParams(window.location.search).get('customerId');
  document.getElementById('CustomerID').value = customerId;

  let actionToken = null;

  async function ensureActionToken() {
    if (actionToken) return actionToken;

    const res = await fetch('/api/get-action-token');
    if (!res.ok) {
      alert('Failed to get action token');
      throw new Error('Failed to get action token');
    }

    const data = await res.json();
    actionToken = data.actionToken;
    return actionToken;
  }

  async function loadDropdowns() {
    const invoiceRes = await fetch(`/feedback/invoices/${customerId}`);
    const bookingRes = await fetch(`/feedback/bookings/${customerId}`);
    const invoices = await invoiceRes.json();
    const bookings = await bookingRes.json();
    const invoiceDropdown = document.getElementById('invoiceDropdown');
    const bookingDropdown = document.getElementById('bookingDropdown');

    invoices.forEach(inv => {
      const option = document.createElement('option');
      option.value = inv.InvoiceID;
      option.textContent = `${inv.InvoiceNumber} (${inv.InvoiceDate})`;
      invoiceDropdown.appendChild(option);
    });

    bookings.forEach(book => {
      const option = document.createElement('option');
      option.value = book.BookingID;
      option.textContent = `#${book.BookingID} (${book["Booking Date"]})`;
      bookingDropdown.appendChild(option);
    });
  }
  loadDropdowns();

  const form = document.getElementById('feedbackForm');
  const submitButton = form.querySelector('button[type="submit"]');
  let editingId = null;

  async function loadFeedback() {
    const res = await fetch(`/feedback/${customerId}`);
    const data = await res.json();
    const list = document.getElementById('feedbackList');
    list.innerHTML = '';

    for (const entry of data) {
      const card = document.createElement('div');
      card.className = 'border p-4 rounded bg-gray-50';
      card.innerHTML = `
        <div><strong>Title:</strong> ${entry.Title || '‚Äî'}</div>
        <div><strong>Type:</strong> ${entry.QueryType || '‚Äî'}</div>
        <div><strong>Status:</strong> ${entry.Status || '‚Äî'}</div>
        <div><strong>Invoice:</strong> ${entry.InvoiceID || '‚Äî'} | <strong>Booking:</strong> ${entry.BookingID || '‚Äî'}</div>
        <div class="my-2">${entry.Message || ''}</div>
        <div class="text-sm text-gray-500">Created: ${entry.CreatedAt || ''}</div>
        <div class="mt-2 flex gap-2">
          <button class="text-blue-600 underline" data-action="edit">‚úèÔ∏è Edit</button>
          <button class="text-red-600 underline" data-action="delete">üóëÔ∏è Delete</button>
          <button class="text-green-600 underline" data-action="close">‚úÖ Close</button>
        </div>

        <form data-reply="${entry.FeedbackID}" class="mt-4 space-y-2">
          <textarea placeholder="Reply message." class="w-full p-2 border rounded" rows="2" name="ReplyMessage" required></textarea>
          <input type="file" name="Attachment" class="block">
          <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded">Send Reply</button>
        </form>
        <div id="replies-${entry.FeedbackID}" class="ml-4 mt-2 space-y-1 text-sm text-gray-700"></div>
      `;

      list.appendChild(card);

      card.querySelector('[data-action="edit"]').addEventListener('click', () => {
        editingId = entry.FeedbackID;
        form.Title.value = entry.Title || '';
        form.Message.value = entry.Message || '';
        form.QueryType.value = entry.QueryType || '';
        form.Status.value = entry.Status || 'Open';
        form.InvoiceID.value = entry.InvoiceID || '';
        form.BookingID.value = entry.BookingID || '';
        submitButton.textContent = 'Update Feedback';
      });

      card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteFeedback(entry.FeedbackID));
      card.querySelector('[data-action="close"]').addEventListener('click', () => closeFeedback(entry.FeedbackID));

      await loadReplies(entry.FeedbackID);
    }
  }

  async function handleReplySubmit(e) {
    e.preventDefault();
    const replyForm = e.target;
    const feedbackId = replyForm.getAttribute('data-reply');

    const token = await ensureActionToken();

    const formData = new FormData();
    formData.append('ReplyMessage', replyForm.ReplyMessage.value);
    if (replyForm.Attachment.files.length > 0) {
      formData.append('Attachment', replyForm.Attachment.files[0]);
    }

    const res = await fetch(`/feedback/${feedbackId}/reply`, {
      method: 'POST',
      headers: {
        'X-Action-Token': token,
      },
      body: formData
    });

    if (res.ok) {
      replyForm.reset();
      loadReplies(feedbackId);
    } else {
      alert('Failed to send reply');
    }
  }

  async function loadReplies(feedbackId) {
    try {
      const res = await fetch(`/feedback/replies/${feedbackId}`);
      const replies = await res.json();
      const container = document.getElementById(`replies-${feedbackId}`);
      container.innerHTML = '';

      replies.forEach(reply => {
        const div = document.createElement('div');
        div.className = 'bg-gray-100 p-2 rounded';
        div.innerHTML = `
          <div><strong>Reply:</strong> ${reply.ReplyMessage}</div>
          ${reply.AttachmentPath ? `<div><a class="text-blue-600 underline" href="/uploads/${reply.AttachmentPath}" target="_blank">üìé Attachment</a></div>` : ''}
          <div class="text-xs text-gray-500">${reply.RepliedAt}</div>
        `;
        container.appendChild(div);
      });
    } catch (err) {
      console.error('Failed to load replies:', err);
    }
  }

  async function closeFeedback(id) {
    const token = await ensureActionToken();
    const res = await fetch(`/feedback/close/${id}`, {
      method: 'POST',
      headers: {
        'X-Action-Token': token,
      },
    });
    if (res.ok) loadFeedback();
  }

  async function deleteFeedback(id) {
    if (!confirm('Are you sure you want to delete this entry?')) return;

    const token = await ensureActionToken();
    const res = await fetch(`/feedback/${id}`, {
      method: 'DELETE',
      headers: {
        'X-Action-Token': token,
      },
    });
    if (res.ok) loadFeedback();
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const token = await ensureActionToken();

    const payload = {
      CustomerID: customerId,
      Title: form.Title.value,
      Message: form.Message.value,
      QueryType: form.QueryType.value,
      Status: form.Status.value,
      InvoiceID: form.InvoiceID.value || null,
      BookingID: form.BookingID.value || null
    };

    const url = editingId ? `/feedback/${editingId}` : '/feedback';
    const method = editingId ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-Action-Token': token,
      },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      form.reset();
      editingId = null;
      submitButton.textContent = 'Submit Feedback';
      loadFeedback();
    } else {
      alert('Failed to submit feedback');
    }
  });

  // Global listener for reply forms
  document.addEventListener('submit', function (e) {
    if (e.target && e.target.hasAttribute('data-reply')) {
      handleReplySubmit(e);
    }
  });

  async function loadCustomerLabel() {
    const res = await fetch(`/customer/${customerId}`);
    const data = await res.json();

    if (data) {
      document.getElementById('customerLabel').textContent =
        `${data['First Name'] || ''} ${data['Last Name'] || ''} (${data['Post Code'] || ''})`;
    }
  }

  document.getElementById('backBtn').href = `/view-customer?id=${customerId}`;

  loadCustomerLabel();
  loadFeedback();
</script>
</body>
</html>
