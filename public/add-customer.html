<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Customer | Rockel Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #toast {
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>

  <div id="toast" class="fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow hidden z-50"></div>
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-4">Add Customer</h2>
    <form id="addCustomerForm" method="POST" action="/add-customer" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input name="Company" placeholder="Company" class="p-2 border rounded" />
        <input name="FirstName" placeholder="First Name" class="p-2 border rounded" required />
        <input name="LastName" placeholder="Last Name" class="p-2 border rounded" required />
        <input name="Email" placeholder="E-mail Address" class="p-2 border rounded" />
        <input name="Phone1" placeholder="Phone 1" class="p-2 border rounded" />
        <input name="Address1" placeholder="Address 1" class="p-2 border rounded" />
        <input name="PostCode" placeholder="Post Code" class="p-2 border rounded" />
        <input name="Country" placeholder="Country" class="p-2 border rounded" />
        <select name="Type" class="p-2 border rounded" required>
          <option value="">Select Type</option>
          <option value="Customer" selected>Customer</option> <!-- ðŸ‘ˆ Default selected -->
          <option value="Business">Business</option>
        </select>        
        <select name="Category" class="p-2 border rounded" required>
          <option value="">Select Region</option>
          <option value="London" selected>London</option> <!-- ðŸ‘ˆ Default selected -->
          <option value="North">North</option>
          <option value="South">South</option>
          <option value="South-West">South-West</option>
          <option value="Freetown">Freetown</option>
          <option value="Other">Other</option>
        </select>        
      </div>
      <select name="ReferralSource" id="referralDropdown" class="p-2 border rounded w-full" onchange="toggleOtherReferral(this)">
        <option value="">How did you hear about us?</option>
        <option value="Google">Google</option>
        <option value="Facebook">Facebook</option>
        <option value="WhatsApp">WhatsApp</option>
        <option value="Friend/Family">Friend/Family</option>
        <option value="Returning Customer">Returning Customer</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" name="ReferralSourceOther" id="referralOther" placeholder="Please specify" class="p-2 border rounded w-full hidden" />
      <input type="text" name="ReferredBy" placeholder="Referral code (optional)" class="p-2 border rounded w-full">
      <textarea name="Notes" placeholder="Notes" class="w-full p-2 border rounded"></textarea>
      <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded">Add Customer</button>
    </form>
    <div class="mt-4">
      <a href="/dashboard" class="text-blue-600 underline">Back to Customer Page</a>
    </div>
  </div>

  <script>
    let actionToken = null;

async function fetchActionToken() {
  try {
    const res = await fetch('/api/get-action-token', { credentials: 'include' });
    if (!res.ok) {
      console.error('Failed to fetch action token');
      return;
    }
    const data = await res.json();
    actionToken = data.actionToken;
  } catch (err) {
    console.error('Error getting action token', err);
  }
}

    function showToast(message, success = true) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed top-4 right-4 px-4 py-2 rounded shadow z-50 ${success ? 'bg-green-600' : 'bg-red-600'} text-white`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    document.getElementById('addCustomerForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;

  const referral = form.ReferralSource.value;
  if (referral === 'Other') {
    form.ReferralSource.value = form.ReferralSourceOther.value;
  }

  // Ensure we have a token
  if (!actionToken) {
    await fetchActionToken();
  }

  // Build form data and append _actionToken
  const fd = new FormData(form);
  fd.append('_actionToken', actionToken);

  const formData = new URLSearchParams(fd).toString();

  const res = await fetch(form.action, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: formData
  });

  if (res.redirected) {
    window.location.href = res.url;
  } else if (res.ok) {
    showToast('Customer added successfully');
    form.reset();
    // Fetch a fresh token for the next action
    await fetchActionToken();
  } else {
    showToast('Failed to add customer', false);
  }
});


    function toggleOtherReferral(select) {
      const otherBox = document.getElementById('referralOther');
      if (select.value === 'Other') {
        otherBox.classList.remove('hidden');
      } else {
        otherBox.classList.add('hidden');
        otherBox.value = '';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
  fetchActionToken();
});


  </script>
</body>
</html>
