<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staff Allocation</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script>
  let staffList = [];
  let actionToken = null;

  // Fetch action token for the MAIN dashboard session
  async function fetchActionToken() {
    try {
      const res = await fetch('/api/get-action-token', { method: 'GET' });
      if (!res.ok) throw new Error('Failed to fetch action token');
      const data = await res.json();
      actionToken = data.actionToken;
    } catch (err) {
      console.error('❌ Error fetching action token:', err);
      alert('Security token error. Please reload the page and try again.');
    }
  }

  async function loadStaffOptions() {
    const res = await fetch('/api/staff/all');
    staffList = await res.json();

    const drivers = staffList.filter(s => s.Role === 'Driver' && s.Status == 1);
    const helpers = staffList.filter(s => s.Role === 'Helper' && s.Status == 1);

    const driverSelect = document.getElementById('driverAll');
    const helper1Select = document.getElementById('helper1All');
    const helper2Select = document.getElementById('helper2All');

    driverSelect.innerHTML =
      `<option value="">Select Driver</option>` +
      drivers.map(d => `<option value="${d.Name}">${d.Name}</option>`).join('');

    helper1Select.innerHTML =
      `<option value="">Select Helper 1</option>` +
      helpers.map(h => `<option value="${h.Name}">${h.Name}</option>`).join('');

    helper2Select.innerHTML =
      `<option value="">Select Helper 2</option>` +
      helpers.map(h => `<option value="${h.Name}">${h.Name}</option>`).join('');
  }
</script>
</head>
<body class="p-6 bg-gray-100">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>
  <h1 class="text-2xl font-bold mb-4">Staff Allocation</h1>

  <!-- Filters -->
  <div class="flex flex-wrap gap-4 mb-6">
    <div>
      <label class="block font-semibold">Select Date</label>
      <input type="date" id="filterDate" class="border p-2 rounded">
    </div>
    <div>
      <label class="block font-semibold">Select Region</label>
      <select id="filterRegion" class="border p-2 rounded">
        <option value="">All</option>
        <option>North</option>
        <option>South</option>
        <option>Freetown</option>
        <option>London</option>
        <option>Other</option>
      </select>
    </div>
    <div>
      <label class="block font-semibold">Allocation</label>
      <select id="filterSlot" class="border p-2 rounded">
        <option value="">All</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
      </select>
    </div>
    <div class="self-end">
      <button onclick="loadBookings()" class="bg-blue-600 text-white px-4 py-2 rounded">Filter</button>
    </div>
  </div>

  <!-- Mass Assignment Controls -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
   <select id="driverAll" class="border p-2 rounded">
      <option value="">Select Driver</option>
    </select>
    <select id="helper1All" class="border p-2 rounded">
      <option value="">Select Helper 1</option>
    </select>
    <select id="helper2All" class="border p-2 rounded">
      <option value="">Select Helper 2</option>
    </select>
    <input type="text" id="vanAll" placeholder="Van" class="border p-2 rounded">
    <input type="text" id="notesAll" placeholder="Notes" class="border p-2 rounded">
  </div>
  <div class="mb-4">
    <button onclick="saveAllAllocations()" class="bg-green-700 text-white px-6 py-2 rounded">Save All Allocations</button>
  </div>

  <!-- Booking List -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded shadow">
      <thead class="bg-blue-100">
        <tr>
          <th class="p-3">Booking ID</th>
          <th class="p-3">Date</th>
          <th class="p-3">Region</th>
          <th class="p-3">Customer</th>
          <th class="p-3">Phone</th>
          <th class="p-3">Slot</th>
        </tr>
      </thead>
      <tbody id="bookingTable" class="divide-y divide-gray-200"></tbody>
    </table>
  </div>

  <script>
  let currentBookings = [];

  async function loadBookings() {
    const date = document.getElementById('filterDate').value;
    const region = document.getElementById('filterRegion').value;
    const slot = document.getElementById('filterSlot').value;

    const res = await fetch(`/api/bookings-to-allocate?date=${date}&region=${region}&slot=${slot}`);
    const data = await res.json();
    currentBookings = data;

    const table = document.getElementById('bookingTable');
    table.innerHTML = '';

    data.forEach(b => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="p-3">${b.BookingID}</td>
        <td class="p-3">${b['Booking Date']}</td>
        <td class="p-3">${b.Category || 'N/A'}</td>
        <td class="p-3">${b.CustomerName || ''}</td>
        <td class="p-3">
          ${(b["Phone 1"] || '')}
          ${(b["Phone 2"] ? ' / ' + b["Phone 2"] : '')}
          ${(b["Phone 3"] ? ' / ' + b["Phone 3"] : '')}
        </td>
        <td class="p-3">${b.BookingSlot || ''}</td>
      `;
      table.appendChild(row);
    });
  }

  async function saveAllAllocations() {
    const driver = document.getElementById('driverAll').value.trim();
    const helper1 = document.getElementById('helper1All').value.trim();
    const helper2 = document.getElementById('helper2All').value.trim();
    const van = document.getElementById('vanAll').value.trim();
    const notes = document.getElementById('notesAll').value.trim();

    if (currentBookings.length === 0) {
      alert("No bookings to allocate.");
      return;
    }

    // Ensure we have an action token before POST
    if (!actionToken) {
      await fetchActionToken();
      if (!actionToken) {
        alert('Security token missing. Please reload the page and try again.');
        return;
      }
    }

    const payload = currentBookings.map(b => ({
      BookingID: b.BookingID,
      DriverName: driver,
      Helper1Name: helper1,
      Helper2Name: helper2,
      Van: van,
      Notes: notes
    }));

    const res = await fetch('/allocate-jobs-batch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Action-Token': actionToken
      },
      body: JSON.stringify(payload)
    });

    if (res.status === 403) {
      alert('Security check failed. Please reload the page and try again.');
      return;
    }

    if (!res.ok) {
      const text = await res.text();
      console.error('❌ Allocation error:', text);
      alert('Failed to save allocations.');
      return;
    }

    const msg = await res.text();
    alert(msg);
    loadBookings();
  }

  // Initial load: get token + data + staff
  (async () => {
    await fetchActionToken();
    await loadBookings();
    await loadStaffOptions();
  })();
</script>
</body>
</html>
