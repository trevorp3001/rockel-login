<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Staff â€“ Rockel Shipping</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topnav">
    <h1>Rockel Shipping â€“ Manage Staff</h1>
    <nav>
      <a href="admin-dashboard.html">Dashboard</a>
      <a href="manage-staff.html">Manage Staff</a>
      <a href="#">Reports</a>
      <a href="#">Settings</a>
    <a href="/staff/logout">Logout</a>
    </nav>
  </header>

    <main class="container">
    <h2 id="formTitle">Add New Staff</h2>
    <form id="staffForm" class="form-responsive">
      <!-- Hidden field to know if we're editing -->
      <input type="hidden" id="editUserId" />

      <input type="text" id="username" placeholder="Username" required />
      <input type="password" id="password" placeholder="Password (leave blank to keep existing when editing)" />
      <select id="role" required>
        <option value="Staff">Staff</option>
        <option value="Admin">Admin</option>
      </select>

      <button type="submit" id="saveBtn">Add Staff</button>
      <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
    </form>

    <h2>Current Staff</h2>
    <div class="table-responsive">
      <table id="staffTable">
        <thead>
          <tr>
            <th>UserID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>


    <script>
  const staffForm = document.getElementById("staffForm");
  const editUserIdInput = document.getElementById("editUserId");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const roleSelect = document.getElementById("role");
  const formTitle = document.getElementById("formTitle");
  const saveBtn = document.getElementById("saveBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const staffTableBody = document.querySelector("#staffTable tbody");

  // ðŸ” Action Token for CSRF-style protection
  let actionToken = null;

  async function fetchActionToken() {
    try {
      const res = await fetch("/api/staff/get-action-token");
      if (!res.ok) throw new Error("Failed to get security token (action token)");
      const data = await res.json();
      actionToken = data.actionToken;
      console.log("âœ… New action token received");
    } catch (err) {
      console.error("Action token error:", err);
      alert("âŒ Could not get security token. Please reload the page.");
    }
  }

  // Load staff list from server
  async function loadStaff() {
    try {
      const res = await fetch("/api/staff-users");
      if (!res.ok) throw new Error("Failed to fetch staff list");
      const staff = await res.json();

      staffTableBody.innerHTML = "";
      staff.forEach((user) => {
        const tr = document.createElement("tr");
        tr.dataset.userId = user.UserID;
        tr.dataset.username = user.Username;
        tr.dataset.role = user.Role;

        tr.innerHTML = `
          <td>${user.UserID}</td>
          <td>${user.Username}</td>
          <td>${user.Role}</td>
          <td>
            <button type="button" class="edit-btn">Edit</button>
            <button type="button" class="delete-btn">Delete</button>
          </td>
        `;
        staffTableBody.appendChild(tr);
      });
    } catch (err) {
      alert("âŒ " + err.message);
    }
  }

  // When we click Edit/Delete in the table
  staffTableBody.addEventListener("click", (e) => {
    const btn = e.target;
    const row = btn.closest("tr");
    if (!row) return;

    const userId = row.dataset.userId;
    const username = row.dataset.username;
    const role = row.dataset.role;

    if (btn.classList.contains("edit-btn")) {
      startEditStaff(userId, username, role);
    } else if (btn.classList.contains("delete-btn")) {
      deleteStaff(userId);
    }
  });

  function startEditStaff(id, username, role) {
    editUserIdInput.value = id;
    usernameInput.value = username;
    passwordInput.value = ""; // blank = keep existing password on save
    roleSelect.value = role;

    formTitle.textContent = "Edit Staff Member";
    saveBtn.textContent = "Update Staff";
    cancelEditBtn.style.display = "inline-block";
  }

  function resetForm() {
    editUserIdInput.value = "";
    staffForm.reset();
    formTitle.textContent = "Add New Staff";
    saveBtn.textContent = "Add Staff";
    cancelEditBtn.style.display = "none";
  }

  cancelEditBtn.addEventListener("click", () => {
    resetForm();
  });

  // Handle Add / Edit submit
  staffForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = editUserIdInput.value;
    const username = usernameInput.value.trim();
    const password = passwordInput.value;
    const role = roleSelect.value;

    if (!username || !role) {
      alert("Username and role are required");
      return;
    }

    // â›” For NEW staff, password MUST be provided
    if (!id && (!password || password.trim() === "")) {
      alert("Password is required when creating a new staff user.");
      return;
    }

    if (!actionToken) {
      alert("Security token missing. Please reload the page.");
      return;
    }

    try {
      let res, data;

      if (!id) {
        // âž• ADD NEW STAFF (POST)
        res = await fetch("/api/staff-users", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Action-Token": actionToken
          },
          body: JSON.stringify({ username, password, role }),
        });
      } else {
        // âœï¸ EDIT EXISTING STAFF (PUT)
        res = await fetch(`/api/staff-users/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Action-Token": actionToken
          },
          body: JSON.stringify({ username, role, password }),
        });
      }

      data = await res.json();

      if (res.status === 403) {
        // Token probably expired â€“ refresh for next time
        await fetchActionToken();
        throw new Error(data.error || "Security token expired. Please try again.");
      }

      if (!res.ok) {
        throw new Error(data.error || "Request failed");
      }

      alert(id ? "âœ… Staff updated successfully" : "âœ… Staff added successfully");
      resetForm();
      await loadStaff();
      // Refresh token for the next action
      await fetchActionToken();
    } catch (err) {
      alert("âŒ " + err.message);
    }
  });

  async function deleteStaff(id) {
    if (!confirm("Are you sure you want to delete this staff member?")) return;

    if (!actionToken) {
      alert("Security token missing. Please reload the page.");
      return;
    }

    try {
      const res = await fetch(`/api/staff-users/${id}`, {
        method: "DELETE",
        headers: {
          "X-Action-Token": actionToken
        }
      });

      const data = await res.json();

      if (res.status === 403) {
        await fetchActionToken();
        throw new Error(data.error || "Security token expired. Please try again.");
      }

      if (!res.ok) {
        throw new Error(data.error || "Failed to delete user");
      }

      alert("âœ… Staff deleted successfully");
      await loadStaff();
      await fetchActionToken();
    } catch (err) {
      alert("âŒ " + err.message);
    }
  }

  // Load token + staff list on page load
  window.addEventListener("load", async () => {
    await fetchActionToken();
    await loadStaff();
  });
</script>


</body>
</html>
