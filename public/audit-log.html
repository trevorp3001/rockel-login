<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Audit Log – Rockel Shipping</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    header {
      background: #004b8d;
      color: #fff;
      padding: 16px 24px;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    main {
      padding: 16px 24px 32px;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
      align-items: end;
    }
    .filters label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #444;
    }
    .filters input,
    .filters select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .filters button {
      padding: 8px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-primary {
      background: #004b8d;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .table-wrapper {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    thead {
      background: #f0f2f5;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    th {
      text-align: left;
      font-weight: 600;
      font-size: 0.78rem;
      color: #555;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .timestamp {
      white-space: nowrap;
    }
    .details {
      max-width: 320px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      color: #444;
    }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #fff;
      border-radius: 0 0 6px 6px;
      border-top: 1px solid #eee;
      font-size: 0.8rem;
    }
    .pagination button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .pagination button[disabled] {
      opacity: 0.5;
      cursor: default;
    }
    .status-text {
      font-size: 0.78rem;
      color: #555;
    }
    .chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e8f0fe;
      color: #174ea6;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Audit Log</h1>
    <p>Internal activity log – staff-only view</p>
  </header>

  <main>
    <section class="filters">
      <div>
        <label for="fromDate">From (date/time)</label>
        <input type="datetime-local" id="fromDate" />
      </div>
      <div>
        <label for="toDate">To (date/time)</label>
        <input type="datetime-local" id="toDate" />
      </div>
      <div>
        <label for="userFilter">Username</label>
        <input type="text" id="userFilter" placeholder="Exact username" />
      </div>
      <div>
        <label for="actionFilter">Action</label>
        <input type="text" id="actionFilter" placeholder="e.g. INVOICE_CREATE" />
      </div>
      <div>
        <label for="entityFilter">Entity type</label>
        <input type="text" id="entityFilter" placeholder="e.g. Invoice, Booking" />
      </div>
      <div>
        <label for="limitSelect">Rows per page</label>
        <select id="limitSelect">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div>
        <button type="button" class="btn-primary" id="applyFiltersBtn">Apply filters</button>
      </div>
      <div>
        <button type="button" class="btn-secondary" id="resetFiltersBtn">Reset</button>
      </div>
    </section>

    <section class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>User</th>
            <th>Zone / Role</th>
            <th>Action</th>
            <th>Entity</th>
            <th>Details</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody id="auditBody">
          <tr><td colspan="7">Loading…</td></tr>
        </tbody>
      </table>

      <div class="pagination">
        <div>
          <button type="button" id="prevPageBtn">&laquo; Prev</button>
          <button type="button" id="nextPageBtn">Next &raquo;</button>
        </div>
        <div class="status-text" id="pageStatus">Page 1</div>
      </div>
    </section>
  </main>

  <script>
    let currentOffset = 0;
    let currentLimit = 50;
    let lastPageCount = 0;

    const bodyEl = document.getElementById('auditBody');
    const fromEl = document.getElementById('fromDate');
    const toEl = document.getElementById('toDate');
    const userEl = document.getElementById('userFilter');
    const actionEl = document.getElementById('actionFilter');
    const entityEl = document.getElementById('entityFilter');
    const limitEl = document.getElementById('limitSelect');
    const statusEl = document.getElementById('pageStatus');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const applyBtn = document.getElementById('applyFiltersBtn');
    const resetBtn = document.getElementById('resetFiltersBtn');

    function formatTimestamp(ts) {
      if (!ts) return '';
      // Expecting ISO string from DB
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return ts;
      return d.toLocaleString();
    }

    function safeText(v) {
      if (v === null || v === undefined) return '';
      return String(v);
    }

    function renderDetails(details) {
      if (!details) return '';
      if (typeof details === 'string') {
        return details;
      }
      // JSON object – render as key: value pairs
      try {
        const entries = Object.entries(details);
        if (!entries.length) return '';
        return entries.map(([k, v]) => `${k}: ${v}`).join('\n');
      } catch {
        return String(details);
      }
    }

    function buildQuery() {
      const params = new URLSearchParams();
      params.set('limit', String(currentLimit));
      params.set('offset', String(currentOffset));

      const fromVal = fromEl.value;
      const toVal = toEl.value;
      const userVal = userEl.value.trim();
      const actionVal = actionEl.value.trim();
      const entityVal = entityEl.value.trim();

      if (fromVal) {
        // datetime-local → ISO
        params.set('from', new Date(fromVal).toISOString());
      }
      if (toVal) {
        params.set('to', new Date(toVal).toISOString());
      }
      if (userVal) params.set('user', userVal);
      if (actionVal) params.set('action', actionVal);
      if (entityVal) params.set('entityType', entityVal);

      return params.toString();
    }

    async function loadAuditLog() {
      bodyEl.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
      currentLimit = Number(limitEl.value) || 50;

      try {
        const qs = buildQuery();
        const res = await fetch(`/api/audit-log?${qs}`);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();

        lastPageCount = Array.isArray(data) ? data.length : 0;
        if (!lastPageCount) {
          bodyEl.innerHTML = '<tr><td colspan="7">No records found.</td></tr>';
        } else {
          bodyEl.innerHTML = '';
          for (const row of data) {
            const tr = document.createElement('tr');

            const tsTd = document.createElement('td');
            tsTd.className = 'timestamp';
            tsTd.textContent = formatTimestamp(row.Timestamp);

            const userTd = document.createElement('td');
            userTd.textContent = safeText(row.Username) || '—';

            const zoneTd = document.createElement('td');
            const zone = safeText(row.Zone) || '—';
            const role = safeText(row.Role) || '';
            zoneTd.innerHTML = '';
            if (zone && zone !== '—') {
              const z = document.createElement('span');
              z.className = 'chip';
              z.textContent = zone;
              zoneTd.appendChild(z);
            }
            if (role) {
              const r = document.createElement('span');
              r.className = 'chip';
              r.textContent = role;
              zoneTd.appendChild(r);
            }
            if (!zoneTd.innerHTML) {
              zoneTd.textContent = '—';
            }

            const actionTd = document.createElement('td');
            actionTd.textContent = safeText(row.Action);

            const entityTd = document.createElement('td');
            const et = safeText(row.EntityType);
            const eid = safeText(row.EntityID);
            entityTd.textContent = et || '—';
            if (eid) {
              entityTd.textContent += ` #${eid}`;
            }

            const detailsTd = document.createElement('td');
            detailsTd.className = 'details';
            detailsTd.textContent = renderDetails(row.Details);

            const ipTd = document.createElement('td');
            ipTd.textContent = safeText(row.IP) || '—';

            tr.appendChild(tsTd);
            tr.appendChild(userTd);
            tr.appendChild(zoneTd);
            tr.appendChild(actionTd);
            tr.appendChild(entityTd);
            tr.appendChild(detailsTd);
            tr.appendChild(ipTd);

            bodyEl.appendChild(tr);
          }
        }

        const pageNum = Math.floor(currentOffset / currentLimit) + 1;
        statusEl.textContent = `Page ${pageNum} – showing ${lastPageCount} row(s)`;

        prevBtn.disabled = currentOffset <= 0;
        nextBtn.disabled = lastPageCount < currentLimit;
      } catch (err) {
        console.error('Failed to load audit log', err);
        bodyEl.innerHTML = '<tr><td colspan="7">Error loading audit log.</td></tr>';
        statusEl.textContent = 'Error loading page';
      }
    }

    applyBtn.addEventListener('click', () => {
      currentOffset = 0;
      loadAuditLog();
    });

    resetBtn.addEventListener('click', () => {
      fromEl.value = '';
      toEl.value = '';
      userEl.value = '';
      actionEl.value = '';
      entityEl.value = '';
      limitEl.value = '50';
      currentOffset = 0;
      loadAuditLog();
    });

    prevBtn.addEventListener('click', () => {
      if (currentOffset <= 0) return;
      currentOffset = Math.max(0, currentOffset - currentLimit);
      loadAuditLog();
    });

    nextBtn.addEventListener('click', () => {
      if (lastPageCount < currentLimit) return;
      currentOffset += currentLimit;
      loadAuditLog();
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', loadAuditLog);
  </script>
</body>
</html>
