<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Container List | Rockel Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
</head>
<body class="bg-gray-100 font-sans">
<!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>

<main class="p-6 max-w-7xl mx-auto">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Containers</h2>
    <a href="/add-container" class="bg-green-600 text-white px-4 py-2 rounded">+ Add Container</a>
  </div>

  <input id="searchBox" type="text" placeholder="Search containers..." class="mb-4 w-full p-2 border rounded" oninput="filterContainers()" />

  <div class="bg-white shadow rounded overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="text-left p-3">Container ID</th>
          <th class="text-left p-3">Container/VIN</th>
          <th class="text-left p-3">Seal/Reg</th>
          <th class="text-left p-3">Voyage No.</th>
          <th class="text-left p-3">Price</th>
          <th class="text-left p-3">Vessel</th>
          <th class="text-left p-3">Carrier</th>
          <th class="text-left p-3">Booking Ref</th>
          <th class="text-left p-3">Size</th>
          <th class="text-left p-3">ETD</th>
          <th class="text-left p-3">ETA</th>
          <th class="text-left p-3">Arrived</th>
          <th class="text-left p-3">Cleared</th>
          <th class="text-left p-3">Status</th>
          <th class="text-left p-3">Notes</th>
          <th class="text-left p-3">Actions</th>
        </tr>
      </thead>
      <tbody id="containerTable"></tbody>

<script>
let actionToken = null;

  async function loadActionToken() {
    const res = await fetch('/api/get-action-token');
    const data = await res.json();
    actionToken = data.actionToken;
  }

function toggleDelayRow(containerId, button) {
  const rowId = 'delay-row-' + containerId;
  const existingRow = document.getElementById(rowId);

  if (existingRow) {
    existingRow.remove();
    button.textContent = 'ðŸ•“ View Delays';
    return;
  }

  const row = document.createElement('tr');
  row.id = rowId;
  row.classList.add('bg-gray-50');
  const cell = document.createElement('td');
  cell.colSpan = 16;
  cell.className = 'p-3 text-sm';
  cell.textContent = 'Loading delay history...';
  row.appendChild(cell);

  button.closest('tr').after(row);

  fetch(`/containers/${containerId}/delays`)
    .then(res => res.json())
    .then(data => {
      if (!data.length) {
        cell.textContent = 'No delays recorded.';
        return;
      }

      const lines = data.map(d => `ðŸ“… ${d.DelayDate} â†’ ETA ${d.NewETA}${d.Reason ? ' (' + d.Reason + ')' : ''}`);
      cell.innerHTML = lines.join('<br>');
    });

  button.textContent = 'ðŸ”½ Hide Delays';
}
</script>

    </table>
  </div>
</main>

<script>
  let containersCache = [];

  let delayMap = {};

  async function fetchDelays() {
    try {
      const res = await fetch('/containers/latest-delays');
      delayMap = await res.json();
    } catch (err) {
      console.error('Failed to load delays', err);
      delayMap = {};
    }
  }

  async function loadContainers() {
    try {
      const res = await fetch('/containers/all');
      containersCache = await res.json();
      await fetchDelays(); // also load delays
      renderContainers(containersCache);
    } catch (err) {
      Toastify({ text: 'Error loading containers', backgroundColor: 'red', duration: 3000 }).showToast();
    }
  }


  function renderContainers(containers) {
    const tbody = document.getElementById('containerTable');
    tbody.innerHTML = '';

    containers.forEach(c => {
      const row = document.createElement('tr');
      row.classList.add('border-t');
      row.innerHTML = `
        <td class="p-3">${c.ContainerID}</td>
        <td class="p-3">${c.ContainerNumber}</td>
        <td class="p-3">${c.ContainerSeal || ''}</td>
        <td class="p-3">${c.VoyageNumber || ''}</td>
        <td class="p-3">Â£${c.Cost || '0.00'}</td>
        <td class="p-3">${c.Vessel}</td>
        <td class="p-3">${c.Carrier}</td>
        <td class="p-3">${c.BookingRef}</td>
        <td class="p-3">${c.Size}</td>
        <td class="p-3">${c.ETD || ''}</td>
        <td class="p-3">
          ${delayMap[String(c.ContainerID)]?.NewETA || c.ETA || ''}
          ${delayMap[String(c.ContainerID)]?.NewETA && delayMap[String(c.ContainerID)]?.NewETA !== c.ETA
            ? '<span class="text-red-600 font-semibold ml-2">Delayed</span>' 
            : ''}
        </td>
        <td class="p-3">${c.DateArrived || ''}</td>
        <td class="p-3">${c.DateCleared || ''}</td>
        <td class="p-3">${c.Status}</td>
        <td class="p-3">${c.Notes || ''}</td>
        <td class="p-3 space-x-2">
      <button onclick="toggleDelayRow(${c.ContainerID}, this)" class="text-indigo-600 underline">ðŸ•“ View Delays</button>
    
          <a href="/edit-container?id=${c.ContainerID}" class="text-blue-600">Edit</a>
          <button onclick="deleteContainer(${c.ContainerID})" class="text-red-600">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function filterContainers() {
    const term = document.getElementById('searchBox').value.toLowerCase();
    const filtered = containersCache.filter(c => {
      return [
        c.ContainerID, c.ContainerNumber, c.Vessel, c.Carrier,
        c.Status, c.BookingRef, c.ContainerSeal, c.Size, c.Notes
      ].some(field => (field || '').toString().toLowerCase().includes(term));
    });
    renderContainers(filtered);
  }

    async function deleteContainer(id) {
    if (!confirm('Are you sure you want to delete this container?')) return;

    const res = await fetch(`/containers/${id}`, {
      method: 'DELETE',
      headers: {
        'X-Action-Token': actionToken
      }
    });

    if (res.ok) {
      Toastify({ text: 'Container deleted', backgroundColor: 'green', duration: 3000 }).showToast();
      loadContainers();
    } else {
      Toastify({ text: 'Failed to delete container', backgroundColor: 'red', duration: 3000 }).showToast();
    }
  }


    window.onload = async () => {
    await loadActionToken();
    await loadContainers();
  };
</script>
</body>
</html>
