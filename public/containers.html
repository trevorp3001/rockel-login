<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Containers | Rockel Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>

  <div class="max-w-7xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-4">Containers</h2>

    <form id="containerForm" class="space-y-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input name="Vessel" placeholder="Vessel" class="p-2 border rounded" required />
        <input name="Carrier" placeholder="Carrier" class="p-2 border rounded" required />
        <select name="Status" class="p-2 border rounded" required>
          <option value="">Select Status</option>
          <option value="Preparing">Preparing</option>
          <option value="In Transit">In Transit</option>
          <option value="Arrived">Arrived</option>
          <option value="Cleared">Cleared</option>
        </select>
        <input name="DateLoaded" type="date" placeholder="Date Loaded" class="p-2 border rounded" />
        <input name="ETD" type="date" placeholder="Estimated Time of Departure" class="p-2 border rounded" />
        <input name="ETA" type="date" placeholder="Estimated Time of Arrival" class="p-2 border rounded" />
        <input name="DateArrive" type="date" placeholder="Date Arrived" class="p-2 border rounded" />
        <input name="DateClear" type="date" placeholder="Date Cleared" class="p-2 border rounded" />
        <input name="BookingRef" placeholder="Booking Ref" class="p-2 border rounded" />
        <input name="ContainerNumber" placeholder="Container Number" class="p-2 border rounded" />
        <input name="ContainerSeal" placeholder="Container Seal" class="p-2 border rounded" />
        <select name="Paid" class="p-2 border rounded">
          <option value="">Paid for?</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
        <input name="Cost" type="number" step="0.01" placeholder="Cost" class="p-2 border rounded" />
        <input name="Weight" placeholder="Weight" class="p-2 border rounded" />
        <select name="Size" class="p-2 border rounded">
          <option value="">Select Size</option>
          <option value="20ft">20ft</option>
          <option value="40ft">40ft</option>
        </select>
      </div>
      <textarea name="Notes" placeholder="Notes" class="w-full p-2 border rounded"></textarea>
      <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded">Create Container</button>
    </form>

    <table class="min-w-full text-sm bg-white border">
      <thead class="bg-gray-200">
        <tr>
          <th class="text-left p-3">Container ID</th>
          <th class="text-left p-3">Vessel</th>
          <th class="text-left p-3">Carrier</th>
          <th class="text-left p-3">Status</th>
          <th class="text-left p-3">Date Loaded</th>
          <th class="text-left p-3">ETD</th>
          <th class="text-left p-3">ETA</th>
          <th class="text-left p-3">Arrived</th>
          <th class="text-left p-3">Cleared</th>
          <th class="text-left p-3">Booking Ref</th>
          <th class="text-left p-3">Container No.</th>
          <th class="text-left p-3">Seal</th>
          <th class="text-left p-3">Paid</th>
          <th class="text-left p-3">Cost</th>
          <th class="text-left p-3">Weight</th>
          <th class="text-left p-3">Size</th>
          <th class="text-left p-3">Notes</th>
          <th class="text-left p-3">Actions</th>
        </tr>
      </thead>
      <tbody id="containerTable"></tbody>
    </table>
  </div>

  <!-- âœ… Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow hidden transition-opacity duration-300 z-50">
    <span id="toast-msg">Success!</span>
  </div>

  <script>
    let actionToken = null;

    async function ensureActionToken() {
      if (actionToken) return actionToken;

      const res = await fetch('/api/get-action-token');
      if (!res.ok) {
        throw new Error('Failed to fetch Action Token');
      }
      const data = await res.json();
      actionToken = data.actionToken;
      return actionToken;
    }

    function showToast(message, success = true) {
      const toast = document.getElementById('toast');
      const msg = document.getElementById('toast-msg');
      msg.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded shadow z-50 transition-opacity duration-300 ${success ? 'bg-green-600' : 'bg-red-600'} text-white`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    async function loadContainers() {
      const res = await fetch('/containers/all');
      const data = await res.json();
      const tbody = document.getElementById('containerTable');
      tbody.innerHTML = '';

      data.forEach(c => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-3">${c.ContainerID}</td>
          <td class="p-3">${c.Vessel}</td>
          <td class="p-3">${c.Carrier}</td>
          <td class="p-3">${c.Status}</td>
          <td class="p-3">${c.DateLoaded}</td>
          <td class="p-3">${c.ETD}</td>
          <td class="p-3">${c.ETA}</td>
          <td class="p-3">${c.DateArrive}</td>
          <td class="p-3">${c.DateClear}</td>
          <td class="p-3">${c.BookingRef}</td>
          <td class="p-3">${c.ContainerNumber}</td>
          <td class="p-3">${c.ContainerSeal}</td>
          <td class="p-3">${c.Paid}</td>
          <td class="p-3">${c.Cost}</td>
          <td class="p-3">${c.Weight}</td>
          <td class="p-3">${c.Size}</td>
          <td class="p-3">${c.Notes}</td>
          <td class="p-3 space-x-2">
            <a href="#" class="text-blue-600">Track</a>
            <button onclick="deleteContainer(${c.ContainerID})" class="text-red-600">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

        async function deleteContainer(id) {
      if (!confirm('Delete this container?')) return;

      try {
        const token = await ensureActionToken();

        const res = await fetch(`/containers/${id}`, {
          method: 'DELETE',
          headers: {
            'X-Action-Token': token
          }
        });

        if (res.ok) {
          showToast('Container deleted');
          loadContainers();
        } else {
          showToast('Failed to delete container', false);
        }
      } catch (err) {
        console.error('Delete container security error', err);
        showToast('Security error while deleting container. Please refresh and try again.', false);
      }
    }


        document.getElementById('containerForm').addEventListener('submit', async e => {
      e.preventDefault();

      try {
        const token = await ensureActionToken();

        const formData = new URLSearchParams(new FormData(e.target)).toString();
        const res = await fetch('/containers', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Action-Token': token
          },
          body: formData
        });

        if (res.ok) {
          e.target.reset();
          loadContainers();
          showToast('Container created');
        } else {
          showToast('Failed to create container', false);
        }
      } catch (err) {
        console.error('Create container security error', err);
        showToast('Security error while creating container. Please refresh and try again.', false);
      }
    });


    loadContainers();
  </script>
</body>
</html>
