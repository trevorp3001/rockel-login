<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track Item | Rockel Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>

  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-4">Track Item</h2>

    <form id="trackingForm" enctype="multipart/form-data" class="space-y-4">
      <input type="hidden" name="ItemID" id="ItemID" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input name="ItemQR" placeholder="Item QR Code (if available)" class="p-2 border rounded" />

        <select name="Stage" id="Stage" class="p-2 border rounded" required>
          <option value="">Select Stage</option>
          <option value="Picked up">Picked up</option>
          <option value="Received (London)">Received (London)</option>
          <option value="Shipped">Shipped</option>
          <option value="Arrived (Freetown)">Arrived (Freetown)</option>
          <option value="Collected (Customer)">Collected (Customer)</option>
          <option value="Delivered">Delivered</option>
        </select>

        <input name="Timestamp" type="datetime-local" class="p-2 border rounded" id="Timestamp" required />
        
      </div>

      <div id="containerDropdown" class="hidden">
        <label class="block text-sm font-medium text-gray-700">Select Container (for Shipped stage only)</label>
        <select name="ContainerID" id="ContainerID" class="p-2 border rounded w-full">
          <option value="">-- Select Container --</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Upload Image (Photo or Signature)</label>
        <input type="file" name="Image" accept="image/*" class="p-2 border rounded w-full" />
      </div>

      <div style="display:none">
        <label class="block text-sm font-medium text-gray-700">Signature (optional)</label>
        <canvas id="signaturePad" width="300" height="150" class="border rounded bg-white mb-2"></canvas>
        <button type="button" onclick="clearSignature()" class="text-sm bg-gray-300 px-2 py-1 rounded">Clear</button>
        <input type="hidden" name="SignatureData" id="SignatureData">
      </div>      

      <textarea name="Notes" placeholder="Notes (optional)" class="w-full p-2 border rounded"></textarea>
      
      <div class="flex gap-2 mt-2">
        <button type="button" id="confirmCollection" class="bg-green-600 text-white px-4 py-1 rounded text-sm">
          Confirm Collection
        </button>
        <button type="button" id="confirmDelivery" class="bg-blue-600 text-white px-4 py-1 rounded text-sm">
          Confirm Delivery
        </button>
      </div>   
      
      <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded">Submit Tracking</button>
      <a href="/invoice-items?invoiceId=INVOICE_ID" id="backToItem" class="inline-block bg-gray-600 text-white px-4 py-2 rounded mt-4">‚Üê Back to Invoice Items</a>

    </form>

    <h3 class="text-xl font-semibold mt-10 mb-2">Tracking History</h3>
    <table class="min-w-full text-sm bg-white border">
      <thead class="bg-gray-200">
        <tr>
          <th class="text-left p-3">Stage</th>
          <th class="text-left p-3">Timestamp</th>
          <th class="text-left p-3">Location</th>
          <th class="text-left p-3">Notes</th>
          <th class="text-left p-3">Container</th>
          <th class="text-left p-3">Image</th>
          <th class="p-2">By</th>
        </tr>
      </thead>
      <tbody id="trackingHistory">
        <!-- History rows will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    let ACTION_TOKEN = null;

async function fetchActionToken() {
  try {
    const res = await fetch('/api/get-action-token');
    if (!res.ok) throw new Error('Failed to fetch action token');
    const data = await res.json();
    ACTION_TOKEN = data.actionToken;
  } catch (err) {
  console.error('‚ùå Failed to load action token:', err);
  alert('Security token error ‚Äì please refresh the page');
}
}

window.addEventListener('load', () => {
  fetchActionToken();
});

let editingTrackingId = null;
    const itemId = new URLSearchParams(window.location.search).get('itemId');
    document.getElementById('ItemID').value = itemId;
  
    async function loadMetaAndHeader() {
      const metaRes = await fetch(`/track-item/meta/${itemId}`);
      const meta = await metaRes.json();
  
      if (meta?.InvoiceID) {
        const invoiceRes = await fetch(`/invoices/single/${meta.InvoiceID}`);
        const invoiceData = await invoiceRes.json();
        const invoice = invoiceData.invoice;
  
        // Update back button
        document.getElementById('backToItem').href = `/invoice-items?invoiceId=${meta.InvoiceID}`;
  
        // Add heading
        const header = document.querySelector('h2');
        header.textContent = `Track Item: ID ${itemId} | Invoice ${invoice?.InvoiceNumber || meta.InvoiceID}`;
  
        // Populate item QR
        const itemQRInput = document.querySelector('input[name="ItemQR"]');
        itemQRInput.value = `${itemId}`;
  
        // Display item QR code instead of invoice QR
        const qrImg = document.createElement('img');
        qrImg.src = `/qr/item/${itemId}`;
        qrImg.alt = 'Item QR Code';
        qrImg.className = 'w-24 h-24 mt-4';
        header.insertAdjacentElement('afterend', qrImg);
      }
    }
  
    const stageSelect = document.getElementById('Stage');
    const imageInput = document.querySelector('input[name="Image"]');
    const signatureSection = document.getElementById('signaturePad').parentElement;
  
    function toggleExtraFields(stage) {
      const showExtras = stage === 'Collected (Customer)' || stage === 'Delivered';
      imageInput.closest('div').style.display = showExtras ? 'block' : 'none';
      signatureSection.style.display = showExtras ? 'block' : 'none';
      const showContainer = stage === 'Shipped';
      document.getElementById('containerDropdown').classList.toggle('hidden', !showContainer);
    }
  
    stageSelect.addEventListener('change', function () {
      toggleExtraFields(this.value);
    });
  
    function setStageAndSubmit(stageText) {
      stageSelect.value = stageText;
      toggleExtraFields(stageText);
      document.querySelector('input[name="Timestamp"]').value = new Date().toISOString().slice(0, 16);
    }
  
    document.getElementById('confirmCollection').addEventListener('click', () => {
      setStageAndSubmit('Collected (Customer)');
    });
  
    document.getElementById('confirmDelivery').addEventListener('click', () => {
      setStageAndSubmit('Delivered');
    });
  
    async function loadContainers() {
      const res = await fetch('/eligible-containers');
      const containers = await res.json();
      const dropdown = document.getElementById('ContainerID');
      containers.forEach(c => {
        const option = document.createElement('option');
        option.value = c.ContainerID;
        option.textContent = `ID ${c.ContainerID} (${c.Vessel} - ${c.Status || ''})`;
        dropdown.appendChild(option);
      });
    }
  
    async function loadTrackingHistory() {
      const res = await fetch(`/track-item/history/${itemId}`);
      const records = await res.json();
      const tbody = document.getElementById('trackingHistory');
      tbody.innerHTML = '';
      records.forEach(r => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-3">${r.Stage}</td>
          <td class="p-3">${r.Timestamp}</td>
          <td class="p-3">${r.Location}</td>
          <td class="p-3">${r.Notes || ''}</td>
          <td class="p-3">
            ${r.ContainerNumber || ''} <br/>
            <span class="text-xs text-gray-500">${r.ContainerID || ''}</span>
          </td>
          <td class="p-3">
            ${r.Image ? `<img src="/uploads/${r.Image}" class="w-20 h-20 object-cover border rounded mb-1" />` : ''}
            ${r.Signature ? `<img src="/uploads/${r.Signature}" class="w-20 h-20 object-cover border rounded" />` : ''}
          </td>
          <td class="p-2">${r.PerformedBy || ''}</td>
          <td class="p-3 space-y-1">
            <button onclick='editTracking(${JSON.stringify(r).replace(/'/g, "\\'")})' class="text-blue-600 hover:underline">Edit</button>
            <button onclick="deleteTracking(${r.TrackingID})" class="text-red-600 hover:underline">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
  
    async function deleteTracking(id) {
  if (!confirm("Are you sure you want to delete this tracking entry?")) return;

  if (!ACTION_TOKEN) {
    await fetchActionToken();
  }

  const res = await fetch(`/track-item/${id}`, {
    method: 'DELETE',
    headers: {
      'X-Action-Token': ACTION_TOKEN  // üîê ADD TOKEN
    }
  });

  if (res.ok) {
    alert("Tracking entry deleted.");
    loadTrackingHistory();
  } else {
    alert("Failed to delete tracking entry.");
  }
}


  
    // Canvas for signature
    const canvas = document.getElementById('signaturePad');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseout', () => drawing = false);
    canvas.addEventListener('mousemove', e => {
      if (!drawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });
    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  
    document.getElementById('trackingForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  if (!ACTION_TOKEN) {
    await fetchActionToken();
    if (!ACTION_TOKEN) return alert("Security token missing. Refresh the page.");
  }

  document.getElementById('SignatureData').value = canvas.toDataURL('image/png');

  const formData = new FormData(e.target);

  const endpoint = editingTrackingId
    ? `/track-item/update/${editingTrackingId}`
    : `/track-item/${itemId}`;

  const method = editingTrackingId ? 'PUT' : 'POST';

  const res = await fetch(endpoint, {
    method: method,
    headers: {
      'X-Action-Token': ACTION_TOKEN  // üîê ADD THIS
    },
    body: formData                     // IMPORTANT: do NOT add Content-Type here
  });

  if (res.ok) {
    alert('Tracking info submitted!');
    e.target.reset();
    editingTrackingId = null;
    document.querySelector('button[type="submit"]').textContent = 'Submit Tracking';
    toggleExtraFields('');
    loadTrackingHistory();
  } else {
  const text = await res.text();
  console.error('‚ùå Failed to submit tracking. Status:', res.status, 'Body:', text);
  alert(`Failed to submit tracking (${res.status}): ${text || 'Unknown error'}`);
}
});

  
    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      document.querySelector('input[name="Timestamp"]').value = now.toISOString().slice(0, 16);
    });

    function editTracking(record) {
      editingTrackingId = record.TrackingID;
      document.getElementById('ItemID').value = record.ItemID;
      document.querySelector('select[name="Stage"]').value = record.Stage;
      document.querySelector('input[name="Timestamp"]').value = record.Timestamp?.slice(0, 16);
      document.querySelector('textarea[name="Notes"]').value = record.Notes || '';
      document.querySelector('input[name="ItemQR"]').value = record.ItemQR || '';

      if (record.ContainerID) {
        document.getElementById('ContainerID').value = record.ContainerID;
      }

      toggleExtraFields(record.Stage);
      document.querySelector('button[type="submit"]').textContent = 'Update Tracking';
    }

  
    // Initial setup
    loadMetaAndHeader();
    loadContainers();
    loadTrackingHistory();
    toggleExtraFields(stageSelect.value);
  
  </script>
</body>
</html>
