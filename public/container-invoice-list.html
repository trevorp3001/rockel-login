<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Container Invoice List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .no-print { display: none; }
      body { writing-mode: horizontal-tb; }
    }
  </style>
</head>
<body class="bg-gray-100 p-4">
  <!-- Header -->
  <header class="bg-blue-700 text-
   p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>
  <div class="no-print mb-4 flex flex-wrap gap-4 items-center">
    <select id="containerSelect" class="border p-2 rounded">
      <option value="">Select Container</option>
    </select>
    <input id="searchBox" type="text" placeholder="Search invoices..." class="border p-2 rounded" />
    <button onclick="printPage()" class="bg-blue-700 text-white px-4 py-2 rounded">Print List</button>
  </div>

  <div id="invoiceList" class="space-y-6"></div>

  <script>
    async function fetchContainers() {
      const res = await fetch('/all-containers');
      const containers = await res.json();
      const select = document.getElementById('containerSelect');
      containers.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.ContainerID;
        opt.textContent = `Container ${c.ContainerID} - ${c.ContainerNumber || ''}`;
        select.appendChild(opt);
      });
    }

    document.getElementById('containerSelect').addEventListener('change', loadInvoices);
    document.getElementById('searchBox').addEventListener('input', filterInvoices);

    let allInvoices = [];

    async function loadInvoices() {
      const containerId = document.getElementById('containerSelect').value;
      if (!containerId) return;

      const res = await fetch(`/api/container/${containerId}/invoices`);
      const data = await res.json();
      console.log('Loaded invoices for container', containerId, data);
      allInvoices = data;
      renderInvoices(allInvoices);
    }

    function filterInvoices() {
      const term = document.getElementById('searchBox').value.toLowerCase();
      const filtered = allInvoices.filter(i =>
        i.InvoiceNumber.toLowerCase().includes(term) ||
        i.CustomerName.toLowerCase().includes(term) ||
        i.ReceiverName.toLowerCase().includes(term)
      );
      renderInvoices(filtered);
    }

    function renderInvoices(list) {
      const container = document.getElementById('invoiceList');
      container.innerHTML = '';
      list.forEach(inv => {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 border rounded shadow';
        div.innerHTML = `
          <h3 class="text-lg font-bold">Invoice ${inv.InvoiceNumber}</h3>
          <p><strong>Customer:</strong> ${inv.CustomerName} (${inv.CustomerPhones})</p>
          <p><strong>Receiver:</strong> ${inv.ReceiverName} (${inv.ReceiverPhones})<br>${inv.Address1} ${inv.Address2}, ${inv.PostCode}, ${inv.Country}</p>
          <p><strong>Items:</strong></p>
          <ul class="list-disc list-inside">
            ${inv.Items.map(item => `<li>${item.ItemName} (${item.Quantity} x ${item.UnitCost})</li>`).join('')}
          </ul>
          ${inv.AllItemsOnContainer ? '' : '<p class="text-yellow-700 font-semibold">⚠️ Not all items from this invoice are in this container.</p>'}
          <p><strong>Notes:</strong> ${inv.Notes || ''}</p>
          <p><strong>Total:</strong> £${inv.TotalAmount.toFixed(2)}</p>
          <p><strong>Outstanding:</strong> £${inv.Outstanding.toFixed(2)}</p>
          <p><strong>Status:</strong> <span class="font-semibold ${inv.Status === 'Paid' ? 'text-green-600' : 'text-red-600'}">${inv.Status}</span></p>
          <a href="/invoice-detail.html?invoiceId=${inv.InvoiceID}" class="text-blue-600 underline no-print">View Invoice</a>
          | <a href="/invoice-items.html?invoiceId=${inv.InvoiceID}" class="text-purple-600 underline no-print">Items</a>
        `;
        container.appendChild(div);
      });
    }

    function printPage() {
      window.print();
    }

    fetchContainers();
  </script>
</body>
</html>
