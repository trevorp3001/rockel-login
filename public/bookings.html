<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Bookings | Rockel Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #toast {
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>

  <div id="toast" class="fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow hidden z-50"></div>

  <div class="max-w-5xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-1">Bookings</h2>
      <div id="customerLabel" class="text-gray-600 font-bold mb-4"></div>

    <form id="bookingForm" class="space-y-4 mb-6">
      <input type="hidden" name="BookingID" id="BookingID" />
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="date" name="BookingDate" class="p-2 border rounded" required />
        <select name="AfternoonEvening" class="p-2 border rounded">
          <option value="">-- Select --</option>
          <option value="Afternoon">Afternoon</option>
          <option value="Evening">Evening</option>
        </select>        
        <div>
          <label class="block text-gray-700">Booking Slot</label>
          <select name="BookingSlot" class="w-full border px-3 py-2 rounded">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
        </div>      
        <select name="Status" class="p-2 border rounded">
          <option value="Pending" selected>Pending</option>
          <option value="Collected">Collected</option>
          <option value="Cancelled">Cancelled</option>
        </select>        
      </div>
      <textarea name="Notes" placeholder="Notes" class="w-full p-2 border rounded"></textarea>
      <div class="flex flex-wrap gap-4">
        <button id="formBtn" type="submit" class="bg-blue-700 text-white px-6 py-2 rounded">Add Booking</button>
        <a id="backBtn" href="#" class="bg-green-600 text-white px-6 py-2 rounded">Back to Customer</a>
      </div>      
    </form>

    <table class="min-w-full text-sm bg-white border">
      <thead class="bg-gray-200">
        <tr>
          <th class="text-left p-3">Date</th>
          <th class="text-left p-3">Afternoon/Evening</th>
          <th class="text-left p-3">Status</th>
          <th class="text-left p-3">Notes</th>
          <th class="text-left p-3">Date Made</th> <!-- ‚úÖ Added -->
          <th class="text-left p-3">Actions</th>
        </tr>
      </thead>
      <tbody id="bookingTable">
        <!-- Rows inserted by JS -->
      </tbody>
    </table>

    <div class="mt-6">
      <a id="backBtn" href="#" class="bg-green-600 text-white px-4 py-2 rounded">Back to Customer Page</a>
    </div>
  </div>

  <script>
    let actionToken = null;

async function fetchActionToken() {
  try {
    const res = await fetch('/api/get-action-token', { credentials: 'include' });
    if (!res.ok) {
      console.error('Failed to fetch action token');
      return;
    }
    const data = await res.json();
    actionToken = data.actionToken;
  } catch (err) {
    console.error('Error getting action token', err);
  }
}

    const customerId = new URLSearchParams(window.location.search).get('customerId');
    let isEditing = false;

    function showToast(message, success = true) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed top-4 right-4 px-4 py-2 rounded shadow z-50 ${success ? 'bg-green-600' : 'bg-red-600'} text-white`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    async function loadBookings() {
      const res = await fetch(`/bookings/${customerId}`);
      const data = await res.json();
      const tbody = document.getElementById('bookingTable');
      tbody.innerHTML = '';
      data.forEach(b => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-3">${b['Booking Date']}</td>
          <td class="p-3">${b['Afternoon/Evening']}</td>
          <td class="p-3">${b.Status}</td>
          <td class="p-3">${b.Notes}</td>
          <td class="p-3">${b.CreatedAt ? new Date(b.CreatedAt).toLocaleString() : ''}</td> <!-- ‚úÖ Date Made -->
          <td class="p-3 space-x-2">
            <button onclick="editBooking(
              ${b.BookingID}, 
              '${b['Afternoon/Evening']}', 
              '${b['Booking Date']}', 
              '${b.BookingSlot}', 
              '${b.Status}', 
              \`${b.Notes?.replace(/`/g, '\`') || ''}\`
            )" class="text-blue-600">üìù</button>

            <button onclick="deleteBooking(${b.BookingID})" class="text-red-600">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function loadCustomerLabel() {
      const res = await fetch(`/customer/${customerId}`);
      const data = await res.json();
      
      if (data) {
        document.getElementById('customerLabel').textContent = `${data['First Name'] || ''} ${data['Last Name'] || ''} (${data['Post Code'] || ''})`;
      }
    }

    loadCustomerLabel();

    function editBooking(id, time, date, slot, status, notes) {
        document.getElementById('BookingID').value = id;
        document.querySelector('[name=AfternoonEvening]').value = time || '';
        document.querySelector('[name=BookingDate]').value = date || '';
        document.querySelector('[name=BookingSlot]').value = slot || '1'; // Preserve saved value
        document.querySelector('[name=Status]').value = status || 'Pending';
        document.querySelector('[name=Notes]').value = notes || '';
        document.getElementById('formBtn').textContent = 'Update Booking';
        isEditing = true;
    }


async function deleteBooking(id) {
  if (!confirm('Are you sure you want to delete this booking?')) return;

  try {
    const res = await fetch(`/bookings/${id}`, {
      method: 'DELETE',
      headers: {
        'X-Action-Token': actionToken || ''
      }
    });

    if (res.status === 403) {
      showToast('Security token missing or invalid. Please reload the page and try again.', false);
      await fetchActionToken(); // prepare for next action
      return;
    }

    if (!res.ok) throw new Error('Failed to delete booking');

    showToast('Booking deleted successfully');
    loadBookings();
    await fetchActionToken(); // rotate token after write
  } catch (err) {
    console.error('‚ùå Error deleting booking:', err);
    showToast('Failed to delete booking', false);
  }
}



   document.getElementById('bookingForm').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const formData = new URLSearchParams(new FormData(form)).toString();
  const bookingId = document.getElementById('BookingID').value;

  // Take a copy before we change it later
  const wasEditing = isEditing;

  const url = wasEditing ? `/bookings/${bookingId}` : `/bookings/${customerId}`;
  const method = wasEditing ? 'PUT' : 'POST';

  // Make sure we have a token
  if (!actionToken) {
    await fetchActionToken();
  }

  const res = await fetch(url, {
    method,
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Action-Token': actionToken || ''
    },
    body: formData
  });

  if (res.status === 403) {
    showToast('Security token missing or expired. Please reload the page and try again.', false);
    // Optional: refresh token ready for next attempt
    await fetchActionToken();
    return;
  }

  if (res.ok) {
    form.reset();
    isEditing = false;
    document.getElementById('formBtn').textContent = 'Add Booking';
    showToast(wasEditing ? 'Booking updated' : 'Booking added');
    loadBookings();
    // Optional: rotate token after a successful write
    await fetchActionToken();
  } else {
    showToast('Failed to save booking', false);
  }
});


    document.getElementById('backBtn').href = `/view-customer?id=${customerId}`;

    window.onload = async () => {
  await fetchActionToken();
  loadBookings();          // your existing function
};

  </script>
</body>
</html>
