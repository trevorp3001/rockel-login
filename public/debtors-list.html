<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debtors List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .no-print { display: none; }
    }
  </style>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex flex-wrap justify-between items-center">
    <a href="/dashboard" class="text-xl font-bold">Rockel Shipping</a>
    <nav class="flex flex-wrap items-center space-x-4">
      <a href="/dashboard" class="underline">Customer</a>
      <a href="/job-list">Bookings</a>
      <a href="/invoices-list" class="hover:underline">Invoices</a>
      <a href="/containers-list" class="hover:underline">Containers</a>
      <a href="/feedback-list" class="hover:underline">Feedback List</a>
      <form action="/logout" method="GET">
        <button class="ml-4 bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </form>
    </nav>
  </header>
  <h1 class="text-2xl font-bold mb-4">Debtors List</h1>

  <div class="bg-white p-4 rounded shadow mb-4">
    <div class="flex flex-wrap gap-4 mb-2">
      <input id="searchBox" type="text" placeholder="Search invoices or names..." class="border p-2 rounded w-full sm:w-64" />
      <select id="containerFilter" class="border p-2 rounded">
        <option value="">All Containers</option>
      </select>
      <select id="regionFilter" class="border p-2 rounded">
        <option value="">All Regions</option>
        <option>London</option>
        <option>North</option>
        <option>South</option>
        <option>South-West</option>
        <option>Freetown</option>
        <option>Other</option>
      </select>
      <select id="typeFilter" class="border p-2 rounded">
        <option value="">All Types</option>
        <option>Customer</option>
        <option>Business</option>
      </select>
      <input id="minOutstanding" type="number" placeholder="Min Outstanding" class="border p-2 rounded w-32" />
      <input id="maxOutstanding" type="number" placeholder="Max Outstanding" class="border p-2 rounded w-32" />
      <input id="startDate" type="date" class="border p-2 rounded" />
      <input id="endDate" type="date" class="border p-2 rounded" />
      <button onclick="loadDebtors()" class="bg-blue-600 text-white px-4 py-2 rounded">Apply Filters</button>
      <button onclick="clearFilters()" class="bg-gray-500 text-white px-4 py-2 rounded">Clear Filters</button>
      <button onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded no-print">Print</button>
    </div>
  </div>

  <div id="debtorList" class="space-y-4"></div>

  <script>
    async function fetchContainers() {
      const res = await fetch('/all-containers');
      const containers = await res.json();
      const dropdown = document.getElementById('containerFilter');
      containers.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.ContainerID;
        opt.textContent = `Container ${c.ContainerID} - ${c.ContainerNumber}`;
        dropdown.appendChild(opt);
      });
    }

    function clearFilters() {
      document.getElementById('searchBox').value = '';
      document.getElementById('containerFilter').value = '';
      document.getElementById('regionFilter').value = '';
      document.getElementById('typeFilter').value = '';
      document.getElementById('minOutstanding').value = '';
      document.getElementById('maxOutstanding').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      loadDebtors();
    }

    async function loadDebtors() {
      const res = await fetch('/api/debtors');
      let data = await res.json();

      const search = document.getElementById('searchBox').value.toLowerCase();
      const containerId = document.getElementById('containerFilter').value;
      const region = document.getElementById('regionFilter').value;
      const type = document.getElementById('typeFilter').value;
      const minOut = parseFloat(document.getElementById('minOutstanding').value) || 0;
      const maxOut = parseFloat(document.getElementById('maxOutstanding').value) || Infinity;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      data = data.filter(d => {
        return (
          (!search || d.InvoiceNumber.toLowerCase().includes(search) || d.CustomerName.toLowerCase().includes(search)) &&
          (!containerId || d.ContainerIDs.includes(parseInt(containerId))) &&
          (!region || d.Region === region) &&
          (!type || d.Type === type) &&
          d.Outstanding >= minOut &&
          d.Outstanding <= maxOut &&
          (!startDate || new Date(d.InvoiceDate) >= new Date(startDate)) &&
          (!endDate || new Date(d.InvoiceDate) <= new Date(endDate))
        );
      });

      const list = document.getElementById('debtorList');
      list.innerHTML = '';

      data.forEach(d => {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded shadow';
        div.innerHTML = `
          <h3 class="font-bold text-lg">Invoice ${d.InvoiceNumber}</h3>
          <p><strong>Customer:</strong> ${d.CustomerName} (${d.Phone1 || ''}, ${d.Phone2 || ''}, ${d.Phone3 || ''})</p>
          <p><strong>Region:</strong> ${d.Region} | <strong>Type:</strong> ${d.Type}</p>
          <p><strong>Tracking:</strong> ${d.TrackingStatus || '—'} | <strong>Containers:</strong> ${d.ContainerIDs.join(', ') || '—'}</p>
          <p><strong>Date:</strong> ${d.InvoiceDate}</p>
          <p><strong>Total:</strong> £${d.Total.toFixed(2)} | <strong>Paid:</strong> £${d.Paid.toFixed(2)} | <strong>Outstanding:</strong> £${d.Outstanding.toFixed(2)}</p>
        `;
        list.appendChild(div);
      });
    }

    fetchContainers();
    loadDebtors();
  </script>
</body>
</html>
